service cloud.firestore {
  match /databases/{database}/documents {
    match /profile/{userId} {
      function isAdmin(resource) {
          return resource.data.admin;
      }

      function isSignedIn() {
          return request.auth != null;
      }

      allow  update, create: if (request.auth.uid == userId && isSignedIn()) || isAdmin(get(/databases/$(database)/documents/profile/$(userId)));
      allow delete: if isAdmin(get(/databases/$(database)/documents/profile/$(userId))) && isSignedIn();
      allow read: if isSignedIn();

      match /friends/{document=**} {
        allow  read, update, create, delete: if (request.auth.uid == userId && isSignedIn()) || isAdmin(get(/databases/$(database)/documents/profile/$(userId)));
      }
    }
  }
}
